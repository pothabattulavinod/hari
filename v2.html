<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hari E Techno School | Student Attendance</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Fredoka+One&display=swap" rel="stylesheet">

<style>
body { font-family:'Roboto',sans-serif; background:#f8f9fa; color:#2c3e50; margin:0; }
h1,h2,h3,h4,h5 { font-family:'Fredoka One',cursive; margin:0; }

.navbar { background:linear-gradient(90deg,#2c5364,#203a43,#0f2027); }
.navbar-brand { font-weight:700; color:#fff; }
.navbar-nav .nav-link { color:#fff; font-weight:500; }
.navbar-nav .nav-link:hover,.navbar-nav .nav-link.active { color:#ffe66d; }

.section-title { text-align:center; margin-bottom:30px; color:#ff6b6b; }

#search-card { max-width:950px; margin:20px auto; padding:30px; border-radius:20px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,0.15); }
#filters { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; }
.input-group-text { background:#0099FF; color:#fff; border:none; border-radius:12px 0 0 12px; }
.form-control,.form-select { border-radius:0 12px 12px 0; border-left:none; }
#filters button { flex:none; background:#0099FF; color:#fff; font-weight:600; border:none; border-radius:12px; }
#filters button:hover { background:#0077cc; }

.result-card-container { max-width:900px; margin:20px auto; }
.result-card { background:#fff; border-radius:15px; padding:20px; margin-bottom:20px; box-shadow:0 6px 20px rgba(0,0,0,0.1); }
.result-card h4 { color:#0099FF; margin-bottom:15px; text-align:center; }

.header-image { width:100%; height:auto; max-height:222px; object-fit:cover; }

.attendance-table { width:100%; border-collapse:collapse; margin-bottom:15px; }
.attendance-table th,.attendance-table td { border:1px solid #ddd; padding:10px; text-align:center; font-weight:500; }
.attendance-table th { background:#0099FF; color:#fff; }

.info-table { width:100%; margin-bottom:20px; }
.info-table td { padding:5px 10px; font-weight:500; }

.month-filter-title {
  font-weight: 600;
  font-size: 1rem;
  color: #0099FF;
  margin-bottom: 5px;
  text-align: left;
}

footer { background:linear-gradient(90deg,#0f2027,#2c5364); color:#fff; text-align:center; padding:20px 0; }

@media(max-width:992px){ #filters{flex-direction:column;align-items:center;gap:10px;} .input-group{width:100%;} #filters button{width:100%;} }
@media(max-width:576px){ .attendance-table th,.attendance-table td{font-size:12px;padding:6px;} .header-image { max-height:150px; } }
</style>
</head>
<body>

<!-- Header Image -->
<img src="https://raw.githubusercontent.com/pothabattulavinod/ad/refs/heads/main/HETSheader1.png" alt="Hari E Techno School Header" class="header-image">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="#">Hari E Techno School</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navMenu">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
        <li class="nav-item"><a class="nav-link active" href="#">Attendance</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<section class="py-5 bg-light">
  <div class="container text-center">
    <h2 class="section-title">Check Your Attendance</h2>
  </div>
</section>

<div id="search-card">
  <div id="filters">
    <div class="input-group flex-fill">
      <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
      <input type="text" id="roll-number" placeholder="Roll Number" class="form-control">
    </div>
    <div class="input-group flex-fill">
      <span class="input-group-text"><i class="bi bi-journal-bookmark"></i></span>
      <select id="class-select" class="form-select"><option value="">Select Class</option></select>
    </div>
    <div class="input-group flex-fill">
      <span class="input-group-text"><i class="bi bi-building"></i></span>
      <input type="text" id="section-input" placeholder="Section" class="form-control">
    </div>
    <div class="input-group flex-fill">
      <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
      <input type="date" id="dob-input" class="form-control">
    </div>
    <button id="search-btn" class="btn w-100 mt-2"><i class="bi bi-search"></i> Search</button>
  </div>
</div>

<div id="result-container" class="result-card-container"></div>

<footer>
  <p>Â© 2025 Hari E Techno School, Rajanagaram | All Rights Reserved</p>
</footer>

<script>
// Worker URL
const WORKER_URL = "https://rough-violet-f922.vinodyadavpothabattula666.workers.dev/";
let attendanceData = [];

// Convert UTC date to YYYY-MM-DD
function utcToLocalYMD(utcDateStr){
  if(!utcDateStr) return "";
  const date=new Date(utcDateStr);
  const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), d=String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

// Fetch attendance data
fetch(WORKER_URL)
  .then(res=>res.json())
  .then(data=>{
    attendanceData = data;
    const classSet = new Set(attendanceData.map(s => s.Class));
    const classSelect = document.getElementById('class-select');
    classSet.forEach(c => classSelect.appendChild(new Option(c,c)));
  })
  .catch(err=>console.error("Failed to fetch attendance data:", err));

// Map codes to full status and colors
const statusMap = { "P":"Present", "A":"Absent", "L":"Late", "LE":"Leave" };
const statusColor = { "P":"green", "A":"red", "L":"orange", "LE":"gray" };

// Helper: "Month Year" display
function getMonthYear(dateStr){
  const date = new Date(dateStr);
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
}

// Generate month filter with Month Name + Year and title
function generateMonthFilter(student, container){
  const infoCols = ["Roll","Name","Class","Section","DOB"];
  const dateCols = Object.keys(student).filter(k => !infoCols.includes(k));
  const monthMap = {};

  dateCols.forEach(d=>{
    const dateObj = new Date(d);
    const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
    if(!monthMap[monthKey]) monthMap[monthKey]=[];
    monthMap[monthKey].push(d);
  });

  const months = Object.keys(monthMap).sort();
  const latestMonth = months[months.length-1];

  // Add title above dropdown
  const title = document.createElement('div');
  title.className = "month-filter-title";
  title.textContent = "Select Month";
  container.appendChild(title);

  const monthSelect = document.createElement('select');
  monthSelect.className = "form-select my-2";

  months.forEach(m=>{
    const monthName = getMonthYear(`${m}-01`);
    const option = new Option(monthName, m);
    if(m===latestMonth) option.selected=true;
    monthSelect.appendChild(option);
  });

  container.appendChild(monthSelect);
  return { monthSelect, monthMap, latestMonth };
}

// Render attendance table
function renderAttendanceTable(student, monthMap, selectedMonth, container){
  const dateCols = monthMap[selectedMonth] || [];
  let rowsHTML = '';
  dateCols.forEach(d=>{
    const statusCode = student[d] || "";
    const formattedDate = utcToLocalYMD(d);
    rowsHTML += `<tr>
      <td>${formattedDate}</td>
      <td style="color:${statusColor[statusCode] || 'black'}; font-weight:600;">${statusMap[statusCode] || statusCode}</td>
    </tr>`;
  });

  container.querySelector('.attendance-table').innerHTML = `
    <tr><th>Date</th><th>Status</th></tr>
    ${rowsHTML}`;
}

// Search button click
document.getElementById('search-btn').addEventListener('click', ()=>{
  const roll = document.getElementById('roll-number').value.trim();
  const cls = document.getElementById('class-select').value;
  const section = document.getElementById('section-input').value.trim();
  const dobInput = document.getElementById('dob-input').value;
  const container = document.getElementById('result-container');

  if(!roll||!cls||!section||!dobInput){
    container.innerHTML='<p class="text-center text-danger">Please fill all fields.</p>';
    return;
  }

  const student = attendanceData.find(s=>
    String(s.Roll)===roll &&
    String(s.Class)===cls &&
    s.Section.toLowerCase()===section.toLowerCase() &&
    utcToLocalYMD(s.DOB)===dobInput
  );

  if(!student){
    container.innerHTML='<p class="text-center text-danger">No student found.</p>';
    return;
  }

  container.innerHTML=`
  <div class="result-card">
    <h4>Attendance Record</h4>
    <table class="info-table">
      <tr><td><strong>Name:</strong> ${student.Name}</td><td><strong>Roll No:</strong> ${student.Roll}</td></tr>
      <tr><td><strong>Class:</strong> ${student.Class}</td><td><strong>Section:</strong> ${student.Section}</td></tr>
      <tr><td><strong>DOB:</strong> ${utcToLocalYMD(student.DOB)}</td></tr>
    </table>
    <div id="month-filter-container"></div>
    <table class="attendance-table"></table>
  </div>`;

  const monthContainer = container.querySelector('#month-filter-container');
  const { monthSelect, monthMap, latestMonth } = generateMonthFilter(student, monthContainer);

  renderAttendanceTable(student, monthMap, latestMonth, container);

  monthSelect.addEventListener('change', ()=>{
    renderAttendanceTable(student, monthMap, monthSelect.value, container);
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
