<!DOCTYPE html>
<html>
<head>
<title>Student Feedback - Hari E Techno School</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.header-title {background:#0d6efd;color:white;padding:20px;text-align:center;font-size:28px;font-weight:bold;}
.section-title {text-align:center;margin-top:20px;font-size:22px;font-weight:bold;}
.teacher-card {padding:15px;background:white;border-radius:8px;border:1px solid #ddd;margin-bottom:15px;}
.teacher-name {font-size:18px;font-weight:bold;margin-bottom:10px;}
.is-duplicate {border-color:red;}
</style>
</head>
<body class="bg-light">

<div class="header-title">Hari E Techno School & Junior College</div>
<div class="container mt-4">
  <div class="section-title">Student Feedback</div>

  <div class="row mt-4">
    <div class="col-md-6 offset-md-3">

      <label class="form-label fw-bold">Class:</label>
      <select id="className" class="form-select" onchange="filterSections()">
        <option value="">Select Class</option>
      </select>

      <label class="form-label fw-bold mt-3">Section:</label>
      <select id="section" class="form-select" onchange="showTeachers()">
        <option value="">Select Section</option>
      </select>

      <div id="teacherContainer" class="mt-4"></div>

      <label class="form-label fw-bold">Student Roll Number:</label>
      <input type="text" id="roll" class="form-control" placeholder="Enter roll number">

      <button class="btn btn-primary mt-4 w-100" onclick="submitFeedback()">Submit Feedback</button>

      <p id="response" class="text-center mt-3 fw-bold text-success"></p>
    </div>
  </div>
</div>

<script>
let staffList = [];
let existingPairs = [];
let scriptURL = "https://script.google.com/macros/s/AKfycbxqvlp0Tf_YSyCGPHSXUffERqa-JDRw1GTf7JCyPZ729CG_5-I3aApE1tan0UAN9zRWmA/exec"; // replace with deployed /exec URL

// Load staff & existing roll-teacher pairs
async function loadData() {
  try{
    // Staff list
    let resp = await fetch(scriptURL);
    staffList = await resp.json();
    let classes = [...new Set(staffList.map(s=>s.class))];
    classes.forEach(cls=>{
      let opt = document.createElement("option");
      opt.value = cls;
      opt.textContent = "Class " + cls;
      document.getElementById("className").appendChild(opt);
    });

    // Existing roll-teacher pairs
    let res2 = await fetch(scriptURL+"?action=getExisting");
    existingPairs = await res2.json();
  } catch(err){
    console.error("Load data error:", err);
  }
}

loadData();

// Filter sections
function filterSections() {
  let classSel = document.getElementById("className").value;
  let secDropdown = document.getElementById("section");
  secDropdown.innerHTML = "<option value=''>Select Section</option>";
  let sections = [...new Set(staffList.filter(t=>t.class==classSel).map(t=>t.section))];
  sections.forEach(sec=>{
    let op=document.createElement("option");
    op.value=sec;
    op.textContent=sec;
    secDropdown.appendChild(op);
  });
}

// Show teachers with rating radio buttons
function showTeachers() {
  let cls=document.getElementById("className").value;
  let sec=document.getElementById("section").value;
  let container=document.getElementById("teacherContainer");
  container.innerHTML="";

  let list = staffList.filter(t=>t.class==cls && t.section==sec);
  list.forEach((t,index)=>{
    // Check if student already submitted for this teacher
    let roll=document.getElementById("roll").value.trim();
    let isDup = existingPairs.includes(roll+"|"+t.teacher);

    container.innerHTML+=`
    <div class="teacher-card shadow-sm ${isDup?'is-duplicate':''}" id="teacherCard_${index}">
      <div class="teacher-name">${t.teacher} ${isDup?'(Already Submitted)':''}</div>
      <div class="form-check"><input class="form-check-input" type="radio" name="rating_${index}" value="Average" ${isDup?'disabled':''}><label class="form-check-label">Average</label></div>
      <div class="form-check"><input class="form-check-input" type="radio" name="rating_${index}" value="Good" ${isDup?'disabled':''}><label class="form-check-label">Good</label></div>
      <div class="form-check"><input class="form-check-input" type="radio" name="rating_${index}" value="Very Good" ${isDup?'disabled':''}><label class="form-check-label">Very Good</label></div>
      <div class="form-check"><input class="form-check-input" type="radio" name="rating_${index}" value="Excellent" ${isDup?'disabled':''}><label class="form-check-label">Excellent</label></div>
      <textarea id="comment_${index}" class="form-control mt-2" rows="2" placeholder="Comments (optional)" ${isDup?'disabled':''}></textarea>
      <input type="hidden" id="teacher_${index}" value="${t.teacher}">
    </div>`;
  });
}

// Update teacher cards dynamically when roll number input changes
document.getElementById("roll").addEventListener("input", function(){
  showTeachers();
});

// Submit feedback
async function submitFeedback(){
  try{
    let roll = document.getElementById("roll").value.trim();
    if(!roll){
      document.getElementById("response").innerText="Roll number is required.";
      return;
    }

    let className = document.getElementById("className").value;
    let section = document.getElementById("section").value;

    let feedbackList=[];
    document.querySelectorAll(".teacher-card").forEach((card,index)=>{
      let teacher=document.getElementById(`teacher_${index}`).value;
      let rating=document.querySelector(`input[name="rating_${index}"]:checked`);
      let comment=document.getElementById(`comment_${index}`).value;
      if(rating) feedbackList.push({teacher,rating:rating.value,comment});
    });

    if(feedbackList.length===0){
      document.getElementById("response").innerText="Please rate at least one teacher.";
      return;
    }

    let res = await fetch(scriptURL,{
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify({className,section,roll,feedback:feedbackList})
    });

    if(!res.ok){
      const errText = await res.text();
      console.error(errText);
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    let result = await res.json();
    document.getElementById("response").innerText=result.message;

    // Update existingPairs to prevent further duplicate submissions
    feedbackList.forEach(fb=>{
      existingPairs.push(roll+"|"+fb.teacher);
    });

    // Refresh teacher cards to show already submitted
    showTeachers();

  } catch(err){
    document.getElementById("response").innerText="Error: "+err;
    console.error(err);
  }
}
</script>

</body>
</html>
